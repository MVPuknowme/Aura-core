const express = require('express');
const bodyParser = require('body-parser');
const { Client } = require('pg');
const crypto = require('crypto');

const app = express();
app.use(bodyParser.json({limit:'2mb'}));

const pg = new Client({ connectionString: process.env.DATABASE_URL });
pg.connect();

function honestyCheck(confidence, threshold = 0.93) {
  const score = confidence?.calibrated || confidence?.avg_logit || 0;
  const pass = score >= threshold;
  return {
    verifier: "honesty-threshold",
    result: pass ? "pass" : "fail",
    details: `score=${score}, required=${threshold}`,
    proof: {},
    threshold
  };
}

app.post('/events', async (req, res) => {
  const event = req.body;
  if (!event.verifications) event.verifications = [];
  event.verifications.push(honestyCheck(event.confidence));

  await pg.query(
    'INSERT INTO introspection_events (id, ts, agent_id, event_json, signature) VALUES ($1,$2,$3,$4,$5)',
    [event.event_id, event.timestamp, event.agent_id, event, event.signature.sig]
  );

  res.json({ok:true, id:event.event_id, honesty:event.verifications.slice(-1)[0]});
});

const PORT = process.env.PORT || 3001;
app.listen(PORT, ()=>console.log('aura-core introspection server running on', PORT));
